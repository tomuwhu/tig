/*! asmsimulator 19-06-2022 */
var app=angular.module("ASMSimulator",[]);app.service("assembler",["opcodes",function(T){return{go:function(e){function s(e,r,t){var a=d(e);if(void 0!==a)return{type:r,value:a};var i=D(e);if(void 0!==i)return{type:t,value:i};if("regaddress"===r&&void 0!==(a=S(e)))return{type:r,value:a};if(i=l(e),isNaN(i))throw"Not a "+t+": "+i;if(i<0||255<i)throw t+" must have a value between 0-255";return{type:t,value:i}}function r(e){switch(e.slice(0,1)){case"[":var r=e.slice(1,e.length-1);return s(r,"regaddress","address");case'"':for(var t=e.slice(1,e.length-1),a=[],i=0,p=t.length;i<p;i++)a.push(t.charCodeAt(i));return{type:"numbers",value:a};case"'":r=e.slice(1,e.length-1);if(1<r.length)throw"Only one character is allowed. Use String instead";return{type:"number",value:r.charCodeAt(0)};default:return s(e,"register","number")}}function t(e,r){if(void 0!==r)throw e+": too many arguments"}for(var a=/^[\t ]*(?:([.A-Za-z]\w*)[:])?(?:[\t ]*([A-Za-z]{2,4})(?:[\t ]+(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*)(?:[\t ]*[,][\t ]*(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*))?)?)?/,i=/^[-+]?[0-9]+$/,p=/^[.A-Za-z]\w*$/,o=[],R={},_={},n={},E=e.split("\n"),l=function(e){if("0x"===e.slice(0,2))return parseInt(e.slice(2),16);if("0o"===e.slice(0,2))return parseInt(e.slice(2),8);if("b"===e.slice(e.length-1))return parseInt(e.slice(0,e.length-1),2);if("d"===e.slice(e.length-1))return parseInt(e.slice(0,e.length-1),10);if(i.exec(e))return parseInt(e,10);throw"Invalid number format"},d=function(e){return"A"===(e=e.toUpperCase())?0:"B"===e?1:"C"===e?2:"D"===e?3:"SP"===e?4:void 0},S=function(e){var r=0,t=0;if("A"===(e=e.toUpperCase())[0])t=0;else if("B"===e[0])t=1;else if("C"===e[0])t=2;else if("D"===e[0])t=3;else{if("SP"!==e.slice(0,2))return;t=4}var a=4===t?2:1;if("-"===e[a])r=-1;else{if("+"!==e[a])return;r=1}r*=parseInt(e.slice(a+1),10);if(r<-16||15<r)throw"offset must be a value between -16...+15";return 8*(r=r<0?32+r:r)+t},D=function(e){return p.exec(e)?e:void 0},c=0,u=E.length;c<u;c++)try{var g=a.exec(E[c]);if(void 0!==g[1]||void 0!==g[2]){if(void 0!==g[1]){f=void 0;var G=g[1],f=G.toUpperCase();if(f in n)throw"Duplicate label: "+G;if("A"===f||"B"===f||"C"===f||"D"===f)throw"Label contains keyword: "+f;_[G]=o.length}if(void 0!==g[2]){var A,h,y,b=g[2].toUpperCase();switch("DB"!==b&&(R[o.length]=c),b){case"DB":if("number"===(A=r(g[3])).type)o.push(A.value);else{if("numbers"!==A.type)throw"DB does not support this operand";for(var M=0,k=A.value.length;M<k;M++)o.push(A.value[M])}break;case"HLT":t("HLT",g[3]),y=T.NONE,o.push(y);break;case"MOV":if(A=r(g[3]),h=r(g[7]),"register"===A.type&&"register"===h.type)y=T.MOV_REG_TO_REG;else if("register"===A.type&&"address"===h.type)y=T.MOV_ADDRESS_TO_REG;else if("register"===A.type&&"regaddress"===h.type)y=T.MOV_REGADDRESS_TO_REG;else if("address"===A.type&&"register"===h.type)y=T.MOV_REG_TO_ADDRESS;else if("regaddress"===A.type&&"register"===h.type)y=T.MOV_REG_TO_REGADDRESS;else if("register"===A.type&&"number"===h.type)y=T.MOV_NUMBER_TO_REG;else if("address"===A.type&&"number"===h.type)y=T.MOV_NUMBER_TO_ADDRESS;else{if("regaddress"!==A.type||"number"!==h.type)throw"MOV does not support this operands";y=T.MOV_NUMBER_TO_REGADDRESS}o.push(y,A.value,h.value);break;case"ADD":if(A=r(g[3]),h=r(g[7]),"register"===A.type&&"register"===h.type)y=T.ADD_REG_TO_REG;else if("register"===A.type&&"regaddress"===h.type)y=T.ADD_REGADDRESS_TO_REG;else if("register"===A.type&&"address"===h.type)y=T.ADD_ADDRESS_TO_REG;else{if("register"!==A.type||"number"!==h.type)throw"ADD does not support this operands";y=T.ADD_NUMBER_TO_REG}o.push(y,A.value,h.value);break;case"SUB":if(A=r(g[3]),h=r(g[7]),"register"===A.type&&"register"===h.type)y=T.SUB_REG_FROM_REG;else if("register"===A.type&&"regaddress"===h.type)y=T.SUB_REGADDRESS_FROM_REG;else if("register"===A.type&&"address"===h.type)y=T.SUB_ADDRESS_FROM_REG;else{if("register"!==A.type||"number"!==h.type)throw"SUB does not support this operands";y=T.SUB_NUMBER_FROM_REG}o.push(y,A.value,h.value);break;case"INC":if(A=r(g[3]),t("INC",g[7]),"register"!==A.type)throw"INC does not support this operand";y=T.INC_REG,o.push(y,A.value);break;case"DEC":if(A=r(g[3]),t("DEC",g[7]),"register"!==A.type)throw"DEC does not support this operand";y=T.DEC_REG,o.push(y,A.value);break;case"CMP":if(A=r(g[3]),h=r(g[7]),"register"===A.type&&"register"===h.type)y=T.CMP_REG_WITH_REG;else if("register"===A.type&&"regaddress"===h.type)y=T.CMP_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===h.type)y=T.CMP_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==h.type)throw"CMP does not support this operands";y=T.CMP_NUMBER_WITH_REG}o.push(y,A.value,h.value);break;case"JMP":if(A=r(g[3]),t("JMP",g[7]),"register"===A.type)y=T.JMP_REGADDRESS;else{if("number"!==A.type)throw"JMP does not support this operands";y=T.JMP_ADDRESS}o.push(y,A.value);break;case"JC":case"JB":case"JNAE":if(A=r(g[3]),t(b,g[7]),"register"===A.type)y=T.JC_REGADDRESS;else{if("number"!==A.type)throw b+" does not support this operand";y=T.JC_ADDRESS}o.push(y,A.value);break;case"JNC":case"JNB":case"JAE":if(A=r(g[3]),t(b,g[7]),"register"===A.type)y=T.JNC_REGADDRESS;else{if("number"!==A.type)throw b+"does not support this operand";y=T.JNC_ADDRESS}o.push(y,A.value);break;case"JZ":case"JE":if(A=r(g[3]),t(b,g[7]),"register"===A.type)y=T.JZ_REGADDRESS;else{if("number"!==A.type)throw b+" does not support this operand";y=T.JZ_ADDRESS}o.push(y,A.value);break;case"JNZ":case"JNE":if(A=r(g[3]),t(b,g[7]),"register"===A.type)y=T.JNZ_REGADDRESS;else{if("number"!==A.type)throw b+" does not support this operand";y=T.JNZ_ADDRESS}o.push(y,A.value);break;case"JA":case"JNBE":if(A=r(g[3]),t(b,g[7]),"register"===A.type)y=T.JA_REGADDRESS;else{if("number"!==A.type)throw b+" does not support this operand";y=T.JA_ADDRESS}o.push(y,A.value);break;case"JNA":case"JBE":if(A=r(g[3]),t(b,g[7]),"register"===A.type)y=T.JNA_REGADDRESS;else{if("number"!==A.type)throw b+" does not support this operand";y=T.JNA_ADDRESS}o.push(y,A.value);break;case"PUSH":if(A=r(g[3]),t(b,g[7]),"register"===A.type)y=T.PUSH_REG;else if("regaddress"===A.type)y=T.PUSH_REGADDRESS;else if("address"===A.type)y=T.PUSH_ADDRESS;else{if("number"!==A.type)throw"PUSH does not support this operand";y=T.PUSH_NUMBER}o.push(y,A.value);break;case"POP":if(A=r(g[3]),t(b,g[7]),"register"!==A.type)throw"PUSH does not support this operand";y=T.POP_REG,o.push(y,A.value);break;case"CALL":if(A=r(g[3]),t(b,g[7]),"register"===A.type)y=T.CALL_REGADDRESS;else{if("number"!==A.type)throw"CALL does not support this operand";y=T.CALL_ADDRESS}o.push(y,A.value);break;case"RET":t(b,g[3]),y=T.RET,o.push(y);break;case"MUL":if(A=r(g[3]),t(b,g[7]),"register"===A.type)y=T.MUL_REG;else if("regaddress"===A.type)y=T.MUL_REGADDRESS;else if("address"===A.type)y=T.MUL_ADDRESS;else{if("number"!==A.type)throw"MULL does not support this operand";y=T.MUL_NUMBER}o.push(y,A.value);break;case"DIV":if(A=r(g[3]),t(b,g[7]),"register"===A.type)y=T.DIV_REG;else if("regaddress"===A.type)y=T.DIV_REGADDRESS;else if("address"===A.type)y=T.DIV_ADDRESS;else{if("number"!==A.type)throw"DIV does not support this operand";y=T.DIV_NUMBER}o.push(y,A.value);break;case"AND":if(A=r(g[3]),h=r(g[7]),"register"===A.type&&"register"===h.type)y=T.AND_REG_WITH_REG;else if("register"===A.type&&"regaddress"===h.type)y=T.AND_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===h.type)y=T.AND_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==h.type)throw"AND does not support this operands";y=T.AND_NUMBER_WITH_REG}o.push(y,A.value,h.value);break;case"OR":if(A=r(g[3]),h=r(g[7]),"register"===A.type&&"register"===h.type)y=T.OR_REG_WITH_REG;else if("register"===A.type&&"regaddress"===h.type)y=T.OR_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===h.type)y=T.OR_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==h.type)throw"OR does not support this operands";y=T.OR_NUMBER_WITH_REG}o.push(y,A.value,h.value);break;case"XOR":if(A=r(g[3]),h=r(g[7]),"register"===A.type&&"register"===h.type)y=T.XOR_REG_WITH_REG;else if("register"===A.type&&"regaddress"===h.type)y=T.XOR_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===h.type)y=T.XOR_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==h.type)throw"XOR does not support this operands";y=T.XOR_NUMBER_WITH_REG}o.push(y,A.value,h.value);break;case"NOT":if(A=r(g[3]),t(b,g[7]),"register"!==A.type)throw"NOT does not support this operand";y=T.NOT_REG,o.push(y,A.value);break;case"SHL":case"SAL":if(A=r(g[3]),h=r(g[7]),"register"===A.type&&"register"===h.type)y=T.SHL_REG_WITH_REG;else if("register"===A.type&&"regaddress"===h.type)y=T.SHL_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===h.type)y=T.SHL_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==h.type)throw b+" does not support this operands";y=T.SHL_NUMBER_WITH_REG}o.push(y,A.value,h.value);break;case"SHR":case"SAR":if(A=r(g[3]),h=r(g[7]),"register"===A.type&&"register"===h.type)y=T.SHR_REG_WITH_REG;else if("register"===A.type&&"regaddress"===h.type)y=T.SHR_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===h.type)y=T.SHR_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==h.type)throw b+" does not support this operands";y=T.SHR_NUMBER_WITH_REG}o.push(y,A.value,h.value);break;default:throw"Invalid instruction: "+g[2]}}}else{var H=E[c].trim();if(""!==H&&";"!==H.slice(0,1))throw"Syntax error"}}catch(e){throw{error:e,line:c}}for(c=0,u=o.length;c<u;c++)if(!angular.isNumber(o[c])){if(!(o[c]in _))throw{error:"Undefined label: "+o[c]};o[c]=_[o[c]]}return{code:o,mapping:R,labels:_}}}}]),app.service("cpu",["opcodes","memory",function(u,g){var e={step:function(){var t=this;if(!0===t.fault)throw"FAULT. Reset to continue.";try{function e(e){if(e<0||e>=t.gpr.length)throw"Invalid register: "+e;return e}function r(e){if(e<0||e>=1+t.gpr.length)throw"Invalid register: "+e;return e}function a(e,r){if(0<=e&&e<t.gpr.length)t.gpr[e]=r;else{if(e!=t.gpr.length)throw"Invalid register: "+e;if(t.sp=r,t.sp<t.minSP)throw"Stack overflow";if(t.sp>t.maxSP)throw"Stack underflow"}}function i(e){if(0<=e&&e<t.gpr.length)return t.gpr[e];if(e==t.gpr.length)return t.sp;throw"Invalid register: "+e}function p(e){var r=e%8,r=r<t.gpr.length?t.gpr[r]:t.sp,e=Math.floor(e/8);return 15<e&&(e-=32),r+e}function s(e){return t.zero=!1,t.carry=!1,256<=e?(t.carry=!0,e%=256):0===e?t.zero=!0:e<0&&(t.carry=!0,e=256- -e%256),e}function o(e){if(e<0||e>=g.data.length)throw"IP outside memory";t.ip=e}function R(e){if(g.store(t.sp--,e),t.sp<t.minSP)throw"Stack overflow"}function _(){var e=g.load(++t.sp);if(t.sp>t.maxSP)throw"Stack underflow";return e}function n(e){if(0===e)throw"Division by 0";return Math.floor(t.gpr[0]/e)}var E,l,d,S,D;if(t.ip<0||t.ip>=g.data.length)throw"Instruction pointer is outside of memory";var c=g.load(t.ip);switch(c){case u.NONE:return!1;case u.MOV_REG_TO_REG:a(E=r(g.load(++t.ip)),i(l=r(g.load(++t.ip)))),t.ip++;break;case u.MOV_ADDRESS_TO_REG:E=r(g.load(++t.ip)),d=g.load(++t.ip),a(E,g.load(d)),t.ip++;break;case u.MOV_REGADDRESS_TO_REG:E=r(g.load(++t.ip)),l=g.load(++t.ip),a(E,g.load(p(l))),t.ip++;break;case u.MOV_REG_TO_ADDRESS:S=g.load(++t.ip),l=r(g.load(++t.ip)),g.store(S,i(l)),t.ip++;break;case u.MOV_REG_TO_REGADDRESS:E=g.load(++t.ip),l=r(g.load(++t.ip)),g.store(p(E),i(l)),t.ip++;break;case u.MOV_NUMBER_TO_REG:a(E=r(g.load(++t.ip)),D=g.load(++t.ip)),t.ip++;break;case u.MOV_NUMBER_TO_ADDRESS:S=g.load(++t.ip),D=g.load(++t.ip),g.store(S,D),t.ip++;break;case u.MOV_NUMBER_TO_REGADDRESS:E=g.load(++t.ip),D=g.load(++t.ip),g.store(p(E),D),t.ip++;break;case u.ADD_REG_TO_REG:E=r(g.load(++t.ip)),l=r(g.load(++t.ip)),a(E,s(i(E)+i(l))),t.ip++;break;case u.ADD_REGADDRESS_TO_REG:E=r(g.load(++t.ip)),l=g.load(++t.ip),a(E,s(i(E)+g.load(p(l)))),t.ip++;break;case u.ADD_ADDRESS_TO_REG:E=r(g.load(++t.ip)),d=g.load(++t.ip),a(E,s(i(E)+g.load(d))),t.ip++;break;case u.ADD_NUMBER_TO_REG:E=r(g.load(++t.ip)),D=g.load(++t.ip),a(E,s(i(E)+D)),t.ip++;break;case u.SUB_REG_FROM_REG:E=r(g.load(++t.ip)),l=r(g.load(++t.ip)),a(E,s(i(E)-t.gpr[l])),t.ip++;break;case u.SUB_REGADDRESS_FROM_REG:E=r(g.load(++t.ip)),l=g.load(++t.ip),a(E,s(i(E)-g.load(p(l)))),t.ip++;break;case u.SUB_ADDRESS_FROM_REG:E=r(g.load(++t.ip)),d=g.load(++t.ip),a(E,s(i(E)-g.load(d))),t.ip++;break;case u.SUB_NUMBER_FROM_REG:E=r(g.load(++t.ip)),D=g.load(++t.ip),a(E,s(i(E)-D)),t.ip++;break;case u.INC_REG:a(E=r(g.load(++t.ip)),s(i(E)+1)),t.ip++;break;case u.DEC_REG:a(E=r(g.load(++t.ip)),s(i(E)-1)),t.ip++;break;case u.CMP_REG_WITH_REG:E=r(g.load(++t.ip)),l=r(g.load(++t.ip)),s(i(E)-i(l)),t.ip++;break;case u.CMP_REGADDRESS_WITH_REG:E=r(g.load(++t.ip)),l=g.load(++t.ip),s(i(E)-g.load(p(l))),t.ip++;break;case u.CMP_ADDRESS_WITH_REG:E=r(g.load(++t.ip)),d=g.load(++t.ip),s(i(E)-g.load(d)),t.ip++;break;case u.CMP_NUMBER_WITH_REG:E=r(g.load(++t.ip)),D=g.load(++t.ip),s(i(E)-D),t.ip++;break;case u.JMP_REGADDRESS:E=e(g.load(++t.ip)),o(t.gpr[E]);break;case u.JMP_ADDRESS:o(D=g.load(++t.ip));break;case u.JC_REGADDRESS:E=e(g.load(++t.ip)),t.carry?o(t.gpr[E]):t.ip++;break;case u.JC_ADDRESS:D=g.load(++t.ip),t.carry?o(D):t.ip++;break;case u.JNC_REGADDRESS:E=e(g.load(++t.ip)),t.carry?t.ip++:o(t.gpr[E]);break;case u.JNC_ADDRESS:D=g.load(++t.ip),t.carry?t.ip++:o(D);break;case u.JZ_REGADDRESS:E=e(g.load(++t.ip)),t.zero?o(t.gpr[E]):t.ip++;break;case u.JZ_ADDRESS:D=g.load(++t.ip),t.zero?o(D):t.ip++;break;case u.JNZ_REGADDRESS:E=e(g.load(++t.ip)),t.zero?t.ip++:o(t.gpr[E]);break;case u.JNZ_ADDRESS:D=g.load(++t.ip),t.zero?t.ip++:o(D);break;case u.JA_REGADDRESS:E=e(g.load(++t.ip)),t.zero||t.carry?t.ip++:o(t.gpr[E]);break;case u.JA_ADDRESS:D=g.load(++t.ip),t.zero||t.carry?t.ip++:o(D);break;case u.JNA_REGADDRESS:E=e(g.load(++t.ip)),t.zero||t.carry?o(t.gpr[E]):t.ip++;break;case u.JNA_ADDRESS:D=g.load(++t.ip),t.zero||t.carry?o(D):t.ip++;break;case u.PUSH_REG:l=e(g.load(++t.ip)),R(t.gpr[l]),t.ip++;break;case u.PUSH_REGADDRESS:l=g.load(++t.ip),R(g.load(p(l))),t.ip++;break;case u.PUSH_ADDRESS:d=g.load(++t.ip),R(g.load(d)),t.ip++;break;case u.PUSH_NUMBER:R(D=g.load(++t.ip)),t.ip++;break;case u.POP_REG:E=e(g.load(++t.ip)),t.gpr[E]=_(),t.ip++;break;case u.CALL_REGADDRESS:E=e(g.load(++t.ip)),R(t.ip+1),o(t.gpr[E]);break;case u.CALL_ADDRESS:D=g.load(++t.ip),R(t.ip+1),o(D);break;case u.RET:o(_());break;case u.MUL_REG:l=e(g.load(++t.ip)),t.gpr[0]=s(t.gpr[0]*t.gpr[l]),t.ip++;break;case u.MUL_REGADDRESS:l=g.load(++t.ip),t.gpr[0]=s(t.gpr[0]*g.load(p(l))),t.ip++;break;case u.MUL_ADDRESS:d=g.load(++t.ip),t.gpr[0]=s(t.gpr[0]*g.load(d)),t.ip++;break;case u.MUL_NUMBER:D=g.load(++t.ip),t.gpr[0]=s(t.gpr[0]*D),t.ip++;break;case u.DIV_REG:l=e(g.load(++t.ip)),t.gpr[0]=s(n(t.gpr[l])),t.ip++;break;case u.DIV_REGADDRESS:l=g.load(++t.ip),t.gpr[0]=s(n(g.load(p(l)))),t.ip++;break;case u.DIV_ADDRESS:d=g.load(++t.ip),t.gpr[0]=s(n(g.load(d))),t.ip++;break;case u.DIV_NUMBER:D=g.load(++t.ip),t.gpr[0]=s(n(D)),t.ip++;break;case u.AND_REG_WITH_REG:E=e(g.load(++t.ip)),l=e(g.load(++t.ip)),t.gpr[E]=s(t.gpr[E]&t.gpr[l]),t.ip++;break;case u.AND_REGADDRESS_WITH_REG:E=e(g.load(++t.ip)),l=g.load(++t.ip),t.gpr[E]=s(t.gpr[E]&g.load(p(l))),t.ip++;break;case u.AND_ADDRESS_WITH_REG:E=e(g.load(++t.ip)),d=g.load(++t.ip),t.gpr[E]=s(t.gpr[E]&g.load(d)),t.ip++;break;case u.AND_NUMBER_WITH_REG:E=e(g.load(++t.ip)),D=g.load(++t.ip),t.gpr[E]=s(t.gpr[E]&D),t.ip++;break;case u.OR_REG_WITH_REG:E=e(g.load(++t.ip)),l=e(g.load(++t.ip)),t.gpr[E]=s(t.gpr[E]|t.gpr[l]),t.ip++;break;case u.OR_REGADDRESS_WITH_REG:E=e(g.load(++t.ip)),l=g.load(++t.ip),t.gpr[E]=s(t.gpr[E]|g.load(p(l))),t.ip++;break;case u.OR_ADDRESS_WITH_REG:E=e(g.load(++t.ip)),d=g.load(++t.ip),t.gpr[E]=s(t.gpr[E]|g.load(d)),t.ip++;break;case u.OR_NUMBER_WITH_REG:E=e(g.load(++t.ip)),D=g.load(++t.ip),t.gpr[E]=s(t.gpr[E]|D),t.ip++;break;case u.XOR_REG_WITH_REG:E=e(g.load(++t.ip)),l=e(g.load(++t.ip)),t.gpr[E]=s(t.gpr[E]^t.gpr[l]),t.ip++;break;case u.XOR_REGADDRESS_WITH_REG:E=e(g.load(++t.ip)),l=g.load(++t.ip),t.gpr[E]=s(t.gpr[E]^g.load(p(l))),t.ip++;break;case u.XOR_ADDRESS_WITH_REG:E=e(g.load(++t.ip)),d=g.load(++t.ip),t.gpr[E]=s(t.gpr[E]^g.load(d)),t.ip++;break;case u.XOR_NUMBER_WITH_REG:E=e(g.load(++t.ip)),D=g.load(++t.ip),t.gpr[E]=s(t.gpr[E]^D),t.ip++;break;case u.NOT_REG:E=e(g.load(++t.ip)),t.gpr[E]=s(~t.gpr[E]),t.ip++;break;case u.SHL_REG_WITH_REG:E=e(g.load(++t.ip)),l=e(g.load(++t.ip)),t.gpr[E]=s(t.gpr[E]<<t.gpr[l]),t.ip++;break;case u.SHL_REGADDRESS_WITH_REG:E=e(g.load(++t.ip)),l=g.load(++t.ip),t.gpr[E]=s(t.gpr[E]<<g.load(p(l))),t.ip++;break;case u.SHL_ADDRESS_WITH_REG:E=e(g.load(++t.ip)),d=g.load(++t.ip),t.gpr[E]=s(t.gpr[E]<<g.load(d)),t.ip++;break;case u.SHL_NUMBER_WITH_REG:E=e(g.load(++t.ip)),D=g.load(++t.ip),t.gpr[E]=s(t.gpr[E]<<D),t.ip++;break;case u.SHR_REG_WITH_REG:E=e(g.load(++t.ip)),l=e(g.load(++t.ip)),t.gpr[E]=s(t.gpr[E]>>>t.gpr[l]),t.ip++;break;case u.SHR_REGADDRESS_WITH_REG:E=e(g.load(++t.ip)),l=g.load(++t.ip),t.gpr[E]=s(t.gpr[E]>>>g.load(p(l))),t.ip++;break;case u.SHR_ADDRESS_WITH_REG:E=e(g.load(++t.ip)),d=g.load(++t.ip),t.gpr[E]=s(t.gpr[E]>>>g.load(d)),t.ip++;break;case u.SHR_NUMBER_WITH_REG:E=e(g.load(++t.ip)),D=g.load(++t.ip),t.gpr[E]=s(t.gpr[E]>>>D),t.ip++;break;default:throw"Invalid op code: "+c}return!0}catch(e){throw t.fault=!0,e}},reset:function(){var e=this;e.maxSP=231,e.minSP=0,e.gpr=[0,0,0,0],e.sp=e.maxSP,e.ip=0,e.zero=!1,e.carry=!1,e.fault=!1}};return e.reset(),e}]),app.service("memory",[function(){var e={data:Array(256),lastAccess:-1,load:function(e){if(e<0||e>=this.data.length)throw"Memory access violation at "+e;return this.lastAccess=e,this.data[e]},store:function(e,r){if(e<0||e>=this.data.length)throw"Memory access violation at "+e;this.lastAccess=e,this.data[e]=r},reset:function(){this.lastAccess=-1;for(var e=0,r=this.data.length;e<r;e++)this.data[e]=0}};return e.reset(),e}]),app.service("opcodes",[function(){return{NONE:0,MOV_REG_TO_REG:1,MOV_ADDRESS_TO_REG:2,MOV_REGADDRESS_TO_REG:3,MOV_REG_TO_ADDRESS:4,MOV_REG_TO_REGADDRESS:5,MOV_NUMBER_TO_REG:6,MOV_NUMBER_TO_ADDRESS:7,MOV_NUMBER_TO_REGADDRESS:8,ADD_REG_TO_REG:10,ADD_REGADDRESS_TO_REG:11,ADD_ADDRESS_TO_REG:12,ADD_NUMBER_TO_REG:13,SUB_REG_FROM_REG:14,SUB_REGADDRESS_FROM_REG:15,SUB_ADDRESS_FROM_REG:16,SUB_NUMBER_FROM_REG:17,INC_REG:18,DEC_REG:19,CMP_REG_WITH_REG:20,CMP_REGADDRESS_WITH_REG:21,CMP_ADDRESS_WITH_REG:22,CMP_NUMBER_WITH_REG:23,JMP_REGADDRESS:30,JMP_ADDRESS:31,JC_REGADDRESS:32,JC_ADDRESS:33,JNC_REGADDRESS:34,JNC_ADDRESS:35,JZ_REGADDRESS:36,JZ_ADDRESS:37,JNZ_REGADDRESS:38,JNZ_ADDRESS:39,JA_REGADDRESS:40,JA_ADDRESS:41,JNA_REGADDRESS:42,JNA_ADDRESS:43,PUSH_REG:50,PUSH_REGADDRESS:51,PUSH_ADDRESS:52,PUSH_NUMBER:53,POP_REG:54,CALL_REGADDRESS:55,CALL_ADDRESS:56,RET:57,MUL_REG:60,MUL_REGADDRESS:61,MUL_ADDRESS:62,MUL_NUMBER:63,DIV_REG:64,DIV_REGADDRESS:65,DIV_ADDRESS:66,DIV_NUMBER:67,AND_REG_WITH_REG:70,AND_REGADDRESS_WITH_REG:71,AND_ADDRESS_WITH_REG:72,AND_NUMBER_WITH_REG:73,OR_REG_WITH_REG:74,OR_REGADDRESS_WITH_REG:75,OR_ADDRESS_WITH_REG:76,OR_NUMBER_WITH_REG:77,XOR_REG_WITH_REG:78,XOR_REGADDRESS_WITH_REG:79,XOR_ADDRESS_WITH_REG:80,XOR_NUMBER_WITH_REG:81,NOT_REG:82,SHL_REG_WITH_REG:90,SHL_REGADDRESS_WITH_REG:91,SHL_ADDRESS_WITH_REG:92,SHL_NUMBER_WITH_REG:93,SHR_REG_WITH_REG:94,SHR_REGADDRESS_WITH_REG:95,SHR_ADDRESS_WITH_REG:96,SHR_NUMBER_WITH_REG:97}}]),app.controller("Ctrl",["$document","$scope","$timeout","cpu","memory","assembler",function(r,i,e,t,p,s){var a;i.memory=p,i.cpu=t,i.error="",i.isRunning=!1,i.displayHex=!0,i.displayInstr=!0,i.displayA=!1,i.displayB=!1,i.displayC=!1,i.displayD=!1,i.speeds=[{speed:1,desc:"1 HZ"},{speed:4,desc:"4 HZ"},{speed:8,desc:"8 HZ"},{speed:16,desc:"16 HZ"}],i.speed=4,i.outputStartIndex=232,i.code='; Simple example\n; Writes Hello World to the output\n\n\tJMP start\nhello: DB "Hello World!" ; Variable\n       DB 0\t; String terminator\n\nstart:\n\tMOV C, hello    ; Point to var \n\tMOV D, 232\t; Point to output\n\tCALL print\n        HLT             ; Stop execution\n\nprint:\t\t\t; print(C:*from, D:*to)\n\tPUSH A\n\tPUSH B\n\tMOV B, 0\n.loop:\n\tMOV A, [C]\t; Get char from var\n\tMOV [D], A\t; Write to output\n\tINC C\n\tINC D  \n\tCMP B, [C]\t; Check if end\n\tJNZ .loop\t; jump if not\n\n\tPOP B\n\tPOP A\n\tRET',i.reset=function(){t.reset(),p.reset(),i.error="",i.selectedLine=-1},i.executeStep=function(){i.checkPrgrmLoaded()||i.assemble();try{var e=t.step();return t.ip in i.mapping&&(i.selectedLine=i.mapping[t.ip]),e}catch(e){return i.error=e,!1}},i.run=function(){i.checkPrgrmLoaded()||i.assemble(),i.isRunning=!0,a=e(function(){!0===i.executeStep()?i.run():i.isRunning=!1},1e3/i.speed)},i.stop=function(){e.cancel(a),i.isRunning=!1},i.checkPrgrmLoaded=function(){for(var e=0,r=p.data.length;e<r;e++)if(0!==p.data[e])return!0;return!1},i.getChar=function(e){e=String.fromCharCode(e);return""===e.trim()?"  ":e},i.assemble=function(){try{i.reset();var e=s.go(i.code),r=(i.mapping=e.mapping,e.code);if(i.labels=e.labels,r.length>p.data.length)throw"Binary code does not fit into the memory. Max "+p.data.length+" bytes are allowed";for(var t=0,a=r.length;t<a;t++)p.data[t]=r[t]}catch(e){void 0!==e.line?(i.error=e.line+" | "+e.error,i.selectedLine=e.line):i.error=e.error}},i.jumpToLine=function(e){r[0].getElementById("sourceCode").scrollIntoView(),i.selectedLine=i.mapping[e]},i.isInstruction=function(e){return void 0!==i.mapping&&void 0!==i.mapping[e]&&i.displayInstr},i.getMemoryCellCss=function(e){return e>=i.outputStartIndex?"output-bg":i.isInstruction(e)?"instr-bg":e>t.sp&&e<=t.maxSP?"stack-bg":""},i.getMemoryInnerCellCss=function(e){return e===t.ip?"marker marker-ip":e===t.sp?"marker marker-sp":e===t.gpr[0]&&i.displayA?"marker marker-a":e===t.gpr[1]&&i.displayB?"marker marker-b":e===t.gpr[2]&&i.displayC?"marker marker-c":e===t.gpr[3]&&i.displayD?"marker marker-d":""}}]),app.filter("flag",function(){return function(e){return e.toString().toUpperCase()}}),app.filter("number",function(){return function(e,r){return r?1==(r=e.toString(16).toUpperCase()).length?"0"+r:r:e.toString(10)}}),app.directive("selectLine",[function(){return{restrict:"A",link:function(p,s,e,r){p.$watch("selectedLine",function(){if(0<=p.selectedLine){for(var e=s[0].value.split("\n"),r=0,t=0;t<e.length&&t!=p.selectedLine;t++)r+=e[t].length+1;var a,i=e[p.selectedLine].length+r;void 0!==s[0].selectionStart&&(s[0].focus(),s[0].selectionStart=r,s[0].selectionEnd=i),document.selection&&document.selection.createRange&&(s[0].focus(),s[0].select(),(a=document.selection.createRange()).collapse(!0),a.moveEnd("character",i),a.moveStart("character",r),a.select())}})}}}]),app.filter("startFrom",function(){return function(e,r){return e.slice(r=+r)}}),app.directive("tabSupport",[function(){return{restrict:"A",link:function(e,r,t,a){r.bind("keydown",function(e){var r,t,a;if(9===e.keyCode)return r=this.value,t=this.selectionStart,a=this.selectionEnd,this.value=r.substring(0,t)+"\t"+r.substring(a),this.selectionStart=this.selectionEnd=t+1,e.preventDefault(),!1})}}}]);